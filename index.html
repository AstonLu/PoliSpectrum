<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>台灣政治光譜分析測驗 v1.1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#fff;} 
    .hidden{display:none;}
    .header,.result-header{text-align:center;margin-bottom:1rem;}
    .intro,.form-container{max-width:1000px;margin:auto;text-align:center;}
    .question{margin-bottom:1rem;}
    .low-confidence {color:red;font-weight:bold;}
  </style>
</head>
<body>
  <!-- 首頁 -->
  <div id="home">
    <div class="header">
      <img src="taiwanpoliticalanalysis.png" alt="Logo" style="max-width:600px;">
      <h1>台灣政治光譜分析測驗</h1>
    </div>
    <div class="intro">
      <p>這是一個快速了解你在台灣政治光譜中位置的小工具。請按 Start 開始。</p>
    </div>
    <div class="text-center mb-5">
      <button id="start-btn" class="btn btn-primary btn-lg">Start</button>
    </div>
  </div>

  <!-- 問卷 -->
  <div id="survey-container" class="hidden">
    <h2 class="text-center">請填寫以下題目</h2>
    <div class="form-container">
      <form id="survey-form"></form>
    </div>
  </div>

  <div class="text-center text-muted mt-5 small">
    本測驗由 Aston 獨立開發，不隸屬任何政黨或利益團體，結果僅供參考。
  </div>

<script>
// 第一階段：升級問卷層面

const rawQuestions = [
  {id:'Q1',  axis:'A', text:'我支持在不預設政治前提下維持兩岸對話，以降低風險。', reverse:false},
  {id:'Q1R', axis:'A', text:'我認為兩岸對話風險過高，應該避免。', reverse:true},
  {id:'Q2',  axis:'A', text:'在主權與經貿之間，我更重視維護主權。', reverse:false},
  {id:'Q2R', axis:'A', text:'我認為維持經貿合作比主權更重要。', reverse:true},
  // ... 依序到每軸至少 4 題，並加入反向題 ...
  {id:'CHK', axis:'', text:'為了確認你有在閱讀，請選擇「1」非常不同意。', reverse:false, is_attention_check:true}
];

// 簡易題序打散（可後續強化保留同軸間隔）
const questions = rawQuestions.sort(() => Math.random() - 0.5);

let startTime;
const timestamps = {};

window.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('survey-form');
  questions.forEach(q => {
    const div = document.createElement('div');
    div.className = 'question';
    div.innerHTML = `
      <p><strong>${q.id}. ${q.text}</strong></p>
      <div class="btn-group" role="group">
        ${['1','2','3','4','5','NA'].map(val =>
          `<input type="radio" 
                  name="${q.id}" 
                  id="${q.id}-${val}" 
                  value="${val}" 
                  class="btn-check">
           <label class="btn btn-outline-secondary" for="${q.id}-${val}">
             ${val==='NA'?'不知道/不適用':val}
           </label>`
        ).join('')}
      </div>`;
    // 紀錄作答時間
    div.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('change', () => {
        timestamps[q.id] = Date.now();
      });
    });
    form.appendChild(div);
  });
  // 加提交按鈕
  const btnDiv = document.createElement('div');
  btnDiv.className = 'text-center mt-4';
  btnDiv.innerHTML = `<button type="submit" class="btn btn-primary btn-lg">提交</button>`;
  form.appendChild(btnDiv);

  // Start 按鈕切換
  document.getElementById('start-btn').onclick = () => {
    startTime = Date.now();
    document.getElementById('home').classList.add('hidden');
    document.getElementById('survey-container').classList.remove('hidden');
  };

  // 表單提交
  form.onsubmit = e => {
    e.preventDefault();
    const answers = {};
    const missing = [];
    questions.forEach(q => {
      const v = form.elements[q.id].value;
      answers[q.id] = v;
      if (!v) missing.push(q.id);
    });
    if (missing.length) {
      alert('請填寫：' + missing.join('、'));
      return;
    }
    // 品質檢測
    const totalTime = Date.now() - startTime;
    const avgTime = totalTime / questions.length;
    const fast = avgTime < 1000;
    const flat = Object.values(answers).every(v => v === answers[questions[0].id]);
    const attentionOK = answers['CHK'] === '1';
    const lowConfidence = fast || flat || !attentionOK;
    if (lowConfidence) {
      alert('⚠️ 作答品質偏低，結果僅供參考。');
    }
    // 送到後端
    fetch('/submit', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ answers, timestamps, totalTime, lowConfidence })
    })
    .then(res => res.json())
    .then(res => {
      // 下一步：接收後端返回的計分與模型結果，並渲染圖表
      console.log(res);
      // TODO: 顯示結果區
    });
  };
});
</script>
</body>
</html>
